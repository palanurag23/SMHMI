
[open_prog_full]: ../../img/Ivaldi_openprogrfull.png "Enable Image Verification"

# Automated manufacturing tools

This section provides an overview of MCUXpresso Secure Provisioning Tool and Ivaldi, prerequisites, platform configuration, and open boot programming.

## MCUXpresso Secure Provisioning Tool

<!---TODO DITA URL -->
The [MCUXpresso Secure Provisioning Tool](https://www.nxp.com/design/software/development-software/mcuxpresso-secure-provisioning-tool:MCUXPRESSO-SECURE-PROVISIONING) is a GUI-based application provided to simplify generation and provisioning of bootable executables on NXP MCU devices. The graphical interface provides a streamlined development flow, making it simpler to prepare, flash and fuse images while leveraging and providing access to existing utilities. Advanced scripting can be achieved using the command-line interface, while even more advanced secure provisioning flows can be accomplished by modifying scripts generated by the tool.

<!---TODO DITA URL -->
For more information and how to use it, please check the [Getting Starting with MCUXpresso Secure Provisioning Tool](https://www.nxp.com/pages/getting-starting-with-mcuxpresso-secure-provisioning-tool:TIP-MCUXPRESSO-SECURE-PROVISIONING-TOOL)

## About Ivaldi

If the manufactures needs a custom solution for flashing the board in production, we have developed a suites of python scripts build on top of lightweight Secure Provisioning SDK (SPSDK).
Ivaldi is a package that is responsible for manufacturing and reprogramming without J-Link. It uses the serial downloader mode within the RT117H boot ROM to communicate with an application called Flashloader that is programmed into RT117H.
It then communicates with a program called blhost that controls various parts of the chip and flash.
Ivaldi was created to focus on the build infrastructure of a customer’s development and manufacturing cycle. Its primary focuses are:

- Factory programming and setting up a new device/product
- Generating AWS IoT Devices
- Creating certificate/key pairs for devices
- Associating policies with devices
- Signing images for OTA and HAB
- Writing and Accessing OTP fuses

The following section gives information about the general flashing of a device without debugging tools.

```{note}

To use Ivaldi, put the board in Serial Download Mode. For doing that, move jumper J203, on top of the board into position “0”. For more infomation see [Hardware Guide for more info](https://www.nxp.com/mcu-smhmi).
```

## Requirements

Ivaldi has the following requirements before usage:

- Migration Guide in the "over_the_air.md" file must be followed
- OpenSSL
- AWS CLI installed
    - <https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html>
    - <https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html#cli-quick-configuration>
- Python 3.6.x
- Linux / Windows CMD / Ubuntu for Windows
- README.md from ivaldi root folder must be followed

##  Platform configuration

Ivaldi uses a platform configuration file “Scripts/sln_platforms_config/sln_tlhmi_iot_config/board_config.py”. This file describes:

- The names of the binaries (from Image_Binaries folder) which will be flashed:
    * BOOTLOADER_NAME
    * DEMO1_NAME
    * DEMO1_NAME_RESOURCES
    * DEMO2_NAME
    * DEMO2_NAME_RESOURCES
    * DEMO3_NAME
    * DEMO3_NAME_RESOURCES
- Flash configurations:
    * FLASH_TYPE
    * FLASH_START_ADDR
    * FLASH_SIZE
- Flash Map
    * Binaries’ images addresses
    * Filesystem starting address and size
    * FICA table addresses

To configure Ivaldi to use specific image binaries from Image_Binaries folder, update “Scripts/sln_platforms_config/sln_tlhmi_iot_config/board_config.py” file.

```{warning}

ANY CHANGES IN “Scripts/sln_platforms_config/sln_tlhmi_iot_config/board_config.py” (EXCEPT BINARIES’
NAMES) WILL ALSO REQUIRE UPDATING THE EMBEDDED CODE AND CONFIGURATIONS.
```

## Open Boot Programming

The Open Boot Programming tool is responsible for creating a device and programming it with the correct images, certificates and artifacts.
This method is a quick and easy way of taking a device/product from the assembly line and getting it ready to ship. It is also good practice to run the Open Boot Programming script before enabling the security features to ensure that all images and artifacts are in working order.
The Open Boot Programming script must only be run when all the images and artifacts are obtained. Before running the script, ensure that the following files and folders exist in the “Image_Binaries” directory of Ivaldi root and that all the files mentioned in the board_config.py exists. After the script was executed,
do not forget to exit the serial downloader mode by moving back the J203 jumper.

A directory "Scripts/sln_tlhmi_iot_open_boot" within the Ivaldi package contains the
“open_prog_full.py” script and a README.
The README file contains build requirements for each image before running the script. If the requirements are not fulfilled,
it could cause the boot failure.

To program the firmware and artifacts, execute the `open_prog_full.py` script that performs the following actions:

- Communicate with the BootROM to program Flashloader
- Create a device with
    - Certificate
    - Private Key
    - Policy Attached in the cloud
- Erase the flash
- Generate littlefs format filesystem, that will contain files specified in the littlefs_file_list.py
- Programming the images
    - Bootloader
    - demo1
    - demo1_resources
    - demo2
    - demo2_resources
    - demo3
    - demo3_resources
    - Program the FICA
    - Program the littlefs

In the current open_prog_full.py python script, the littlefs is being generated to contains all the files mentioned in littlefs_file_list.py. Four files are expected:
* Root CA certificate
* AppA sign certificate - validated by the CA certificate and used to sign all the images that are being written or send for update
* AWS certificate - used to validate connection with AWS  server
* AWK public key - used to communicate with AWS MQTT server

One drawback of the current littlefs implementation is that it does not support the attributes. Used in the SLN_TLHMI_IOT project to generate encrypted files.

```{warning}
OPEN PROGRAMMING SCRIPT ASSUMES THE POLICY IS CALLED `tlhmi_deployment`. UPDATE THE SCRIPT TO USE THE CORRECT POLICY NAME IN THE CUSTOMERS AWS ACCOUNT.
```

The script can be used also for development purpose in case there are no debugging probes or ports available on the board.

Calling the script with `-h` argument will show you all the possible combinations and how to use it at full power.
By default the script will not write all 3 applications. To do that call it with `-fbb -fbc` parameters, which allows you to write applications in bank B and C. Putting the `-awsd` parameter will disable AWS thing creation and it will not obtain any certificate.
For debugging purpose is recommended to have the image verification off. For this call the script mentioned with `-ivd`.

```{note}
To be able to write anything in a NOR flash device, an erase operation takes place before the write. The erase operation is very costly and can take up to couple of minutes.
```
